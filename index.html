<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Projects + Kanban — Simple (Free, Local)</title>
  <style>
    /* Option 2 — Slightly modern cards with colored strip */
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#111;background:#f3f4f6}
    .wrap{display:flex;gap:12px;padding:12px;height:100vh}
    .panel{background:#fff;border:1px solid #e6e6e6;border-radius:8px;padding:12px;overflow:auto}
    .left{width:220px}
    .center{flex:1;display:flex;flex-direction:column}
    .board{display:flex;gap:12px;margin-top:12px}
    .col{flex:1;min-width:160px;background:#fbfbfb;border:1px dashed #e9e9e9;border-radius:6px;padding:8px;display:flex;flex-direction:column}
    h2{margin:0 0 8px 0;font-size:16px}
    h3{margin:0 0 8px 0;font-size:14px}
    label{display:block;font-size:13px;margin:6px 0 4px}
    input,textarea,select,button{width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:6px;font-size:14px}
    textarea{resize:vertical}
    button{background:#0b74de;color:#fff;border:none}

    /* Task card style option 2 */
    .task{background:#fff;padding:8px;border:1px solid #ececec;border-radius:6px;cursor:grab;margin-bottom:8px;position:relative;display:flex;gap:10px;align-items:flex-start}
    .status-strip{width:6px;height:100%;border-radius:4px;background:#ccc;flex:0 0 6px}
    .task-content{flex:1}
    .task-content strong{display:block;margin-bottom:4px}
    .task-content small{display:block;color:#666}
    .task-actions{margin-left:8px;display:flex;flex-direction:column;gap:6px}
    .task-actions button{padding:6px 8px;font-size:13px;border-radius:6px}

    .project-item{padding:8px;border-radius:6px;cursor:pointer;margin-bottom:6px}
    .project-item.active{background:#0b74de;color:#fff}

    .kpi{background:#fff;border:1px solid #ececec;border-radius:6px;padding:8px;margin-bottom:8px;text-align:center}
    .foot{font-size:12px;color:#666;margin-top:12px}

    @media (max-width:900px){.wrap{flex-direction:column}.left{width:auto}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Left: Projects -->
    <div class="panel left">
      <h2>Projects</h2>
      <label>New project</label>
      <input id="projName" placeholder="Project name" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="addProj">Add</button>
        <button id="delProj" style="background:#dc3545">Delete</button>
      </div>
      <div style="margin-top:12px">
        <h3 style="font-size:13px;margin:0 0 6px 0">Project list</h3>
        <div id="projectList"></div>
      </div>
      <div style="margin-top:12px">
        <h3 style="font-size:13px;margin:0 0 6px 0">Instructions</h3>
        <ul style="padding-left:18px;margin:0;font-size:13px;color:#444">
          <li>Click a project to open its board.</li>
          <li>Use seed/demo to add an example project.</li>
        </ul>
      </div>
      <div class="foot">Free & local: projects and tasks stored in your browser only.</div>
    </div>

    <!-- Center: Board for selected project -->
    <div class="panel center">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="boardTitle">Select a project</h2>
          <div id="boardSubtitle" style="color:#666;font-size:13px"></div>
        </div>
        <div style="width:320px">
          <label>New task title</label>
          <input id="taskTitle" placeholder="Task title" />
          <label style="margin-top:6px">Assign to</label>
          <select id="assignee"></select>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="createTask">Create Task</button>
        <button id="seed" style="background:#6c757d">Seed Demo</button>
        <button id="manageTeam" style="background:#f59e0b">Manage Team</button>
      </div>

      <div class="board" id="board">
        <div class="col" data-status="todo">
          <h3>To Do <span id="ctTodo" style="float:right;color:#888;font-size:13px"></span></h3>
          <div id="todo" class="task-list"></div>
        </div>
        <div class="col" data-status="doing">
          <h3>Doing <span id="ctDoing" style="float:right;color:#888;font-size:13px"></span></h3>
          <div id="doing" class="task-list"></div>
        </div>
        <div class="col" data-status="done">
          <h3>Done <span id="ctDone" style="float:right;color:#888;font-size:13px"></span></h3>
          <div id="done" class="task-list"></div>
        </div>
      </div>
    </div>

    <!-- Right: Dashboard -->
    <div class="panel" style="width:260px">
      <h2>Dashboard</h2>
      <div class="kpi"><h3 id="kTotal">0</h3><p>Total tasks (project)</p></div>
      <div class="kpi"><h3 id="kActive">0</h3><p>Active</p></div>
      <div class="kpi"><h3 id="kDone">0</h3><p>Completed</p></div>
      <div style="margin-top:8px">
        <h3 style="font-size:13px;margin:0 0 6px 0">Recent completed</h3>
        <ul id="recent" style="padding-left:18px;margin:0;color:#333;font-size:13px"></ul>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="export" style="flex:1;background:#28a745">Export CSV</button>
        <button id="clearAll" style="flex:1;background:#dc3545">Clear</button>
      </div>
      <div class="foot">Reality: works in this browser only. Free to use.</div>
    </div>
  </div>

  <script>
    const STORAGE = 'projects_kanban_v2'
    const DEFAULT_TEAM = ['Alice','Bob','Charlie']

    function load(){ try{return JSON.parse(localStorage.getItem(STORAGE) || '{}')}catch(e){return{}} }
    function save(s){ localStorage.setItem(STORAGE, JSON.stringify(s)) }

    let state = load(); if(!state.projects) state.projects = []
    if(!state.team) state.team = DEFAULT_TEAM
    let currentProjectId = null

    const projectListEl = document.getElementById('projectList')
    const projName = document.getElementById('projName')
    const addProjBtn = document.getElementById('addProj')
    const delProjBtn = document.getElementById('delProj')
    const assigneeSel = document.getElementById('assignee')

    const taskTitle = document.getElementById('taskTitle')
    const createTaskBtn = document.getElementById('createTask')
    const boardTitle = document.getElementById('boardTitle')
    const boardSubtitle = document.getElementById('boardSubtitle')
    const todoEl = document.getElementById('todo'), doingEl = document.getElementById('doing'), doneEl = document.getElementById('done')

    function uid(){ return Math.random().toString(36).slice(2,9) }

    function renderProjects(){ projectListEl.innerHTML=''; state.projects.forEach(p=>{
      const d = document.createElement('div'); d.className='project-item'+(p.id===currentProjectId? ' active':''); d.textContent = p.name; d.addEventListener('click', ()=>{ currentProjectId = p.id; render(); })
      projectListEl.appendChild(d)
    }) }

    function renderTeam(){ assigneeSel.innerHTML='';
      const team = getProjectTeam()
      team.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; assigneeSel.appendChild(o) })
    }

    function getProject(){ return state.projects.find(x=>x.id===currentProjectId) }
    function getProjectTeam(){ const p = getProject(); return p && p.team ? p.team : state.team }

    function render(){ renderProjects(); renderTeam();
      const p = getProject()
      if(!p){ boardTitle.textContent = 'Select a project'; boardSubtitle.textContent = '' ; todoEl.innerHTML='';doingEl.innerHTML='';doneEl.innerHTML=''; updateKPIs([]); return }
      boardTitle.textContent = p.name
      boardSubtitle.textContent = 'Tasks: ' + p.tasks.length

      todoEl.innerHTML=''; doingEl.innerHTML=''; doneEl.innerHTML=''
      let ctTodo=0,ctDoing=0,ctDone=0
      p.tasks.forEach(t=>{
        const el = document.createElement('div'); el.className='task'; el.draggable=true; el.dataset.id = t.id

        // colored strip by status
        const strip = document.createElement('div'); strip.className='status-strip'
        strip.style.background = (t.status==='done'? '#16a34a': t.status==='doing'? '#f59e0b' : '#94a3b8')

        const content = document.createElement('div'); content.className='task-content'
        content.innerHTML = `<strong>${escapeHtml(t.title)}</strong><small>${escapeHtml(t.assignee||'Unassigned')} ${t.accepted? '• Accepted':''}</small>`

        const actions = document.createElement('div'); actions.className='task-actions'

        // Accept button (if assigned and not accepted)
        if(t.assignee && !t.accepted){ const b = document.createElement('button'); b.textContent='Accept'; b.addEventListener('click',(ev)=>{ ev.stopPropagation(); t.accepted=true; t.history = t.history||[]; t.history.push({when:Date.now(),who:t.assignee,action:'accepted'}); save(state); render() }); actions.appendChild(b) }

        // Start / Complete quick buttons depending on state
        if(t.accepted && t.status==='todo'){ const b = document.createElement('button'); b.textContent='Start'; b.addEventListener('click',(ev)=>{ ev.stopPropagation(); t.status='doing'; t.startedAt = Date.now(); t.history = t.history||[]; t.history.push({when:Date.now(),who:t.assignee,action:'started'}); save(state); render() }); actions.appendChild(b) }
        if(t.status==='doing'){ const b = document.createElement('button'); b.textContent='Complete'; b.addEventListener('click',(ev)=>{ ev.stopPropagation(); t.status='done'; t.completedAt = Date.now(); t.history = t.history||[]; t.history.push({when:Date.now(),who:t.assignee,action:'completed'}); save(state); render() }); actions.appendChild(b) }

        el.appendChild(strip); el.appendChild(content); el.appendChild(actions)

        el.addEventListener('click', ()=>{ if(!t.accepted && t.assignee){ if(confirm('Accept this task?')){ t.accepted=true; t.history = t.history||[]; t.history.push({when:Date.now(),who:t.assignee,action:'accepted'}); save(state); render() } } })
        el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', t.id) })

        if(t.status==='todo'){ todoEl.appendChild(el); ctTodo++ }
        if(t.status==='doing'){ doingEl.appendChild(el); ctDoing++ }
        if(t.status==='done'){ doneEl.appendChild(el); ctDone++ }
      })
      document.getElementById('ctTodo').textContent = ctTodo
      document.getElementById('ctDoing').textContent = ctDoing
      document.getElementById('ctDone').textContent = ctDone
      updateKPIs(p.tasks)
    }

    function updateKPIs(tasks){ document.getElementById('kTotal').textContent = tasks.length
      document.getElementById('kDone').textContent = tasks.filter(x=>x.status==='done').length
      document.getElementById('kActive').textContent = tasks.filter(x=>x.status!=='done').length
      const recent = (tasks.filter(x=>x.status==='done').slice(-6).reverse())
      const recentEl = document.getElementById('recent'); recentEl.innerHTML=''
      recent.forEach(r=>{ const li=document.createElement('li'); li.textContent = r.title + ' — ' + r.assignee; recentEl.appendChild(li) }) }

    addProjBtn.addEventListener('click', ()=>{
      const name = projName.value.trim(); if(!name){ alert('Project name required'); return }
      const p = {id:uid(),name,tasks:[],team:[...state.team]}
      state.projects.push(p); save(state); projName.value=''; currentProjectId = p.id; render()
    })

    delProjBtn.addEventListener('click', ()=>{
      if(!currentProjectId){ alert('Select a project first'); return }
      if(!confirm('Delete selected project?')) return
      state.projects = state.projects.filter(x=>x.id!==currentProjectId); currentProjectId = state.projects[0]? state.projects[0].id : null; save(state); render()
    })

    createTaskBtn.addEventListener('click', ()=>{
      const p = getProject(); if(!p){ alert('Select project'); return }
      const title = taskTitle.value.trim(); const assignee = assigneeSel.value
      if(!title){ alert('Task title required'); return }
      p.tasks.push({id:uid(),title,assignee,status:'todo',accepted:false,created:Date.now(),history:[]})
      save(state); taskTitle.value=''; render()
    })

    document.querySelectorAll('.col').forEach(col=>{
      col.addEventListener('dragover', e=>{ e.preventDefault() })
      col.addEventListener('drop', e=>{
        e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); const status = col.dataset.status
        const p = getProject(); if(!p) return
        const task = p.tasks.find(x=>x.id===id); if(!task) return
        // rule: only move to doing if accepted
        if(status==='doing' && !task.accepted){ alert('Please accept the task first (click Accept).'); return }
        task.status = status
        if(status==='done' && !task.completedAt) task.completedAt = Date.now()
        save(state); render()
      })
    })

    // seed demo
    document.getElementById('seed').addEventListener('click', ()=>{
      const p = {id:uid(),name:'Website Redesign',tasks:[
        {id:uid(),title:'Create wireframes',assignee:'Alice',status:'todo',accepted:false,history:[]},
        {id:uid(),title:'Review copy',assignee:'Bob',status:'todo',accepted:false,history:[]},
        {id:uid(),title:'Deploy',assignee:'Charlie',status:'done',accepted:true,completedAt:Date.now()-86400000,history:[]}
      ],team:[...state.team]}
      state.projects.push(p); save(state); currentProjectId = p.id; render()
    })

    // manage team per project
    document.getElementById('manageTeam').addEventListener('click', ()=>{
      const p = getProject(); if(!p){ alert('Select project'); return }
      const current = (p.team||[]).join(',')
      const val = prompt('Edit team members (comma separated)', current)
      if(val===null) return
      const arr = val.split(',').map(x=>x.trim()).filter(x=>x)
      p.team = arr
      save(state); render()
    })

    // export CSV for project
    document.getElementById('export').addEventListener('click', ()=>{
      const p = getProject(); if(!p){ alert('Select project'); return }
      const rows = [['Title','Assignee','Status','CompletedAt']]
      p.tasks.forEach(t=> rows.push([t.title,t.assignee,t.status,t.completedAt?new Date(t.completedAt).toLocaleString():'']))
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n')
      const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(p.name.replace(/\\s+/g,'_')||'project')+'_tasks.csv'; a.click(); URL.revokeObjectURL(url)
    })

    // clear all
    document.getElementById('clearAll').addEventListener('click', ()=>{ if(confirm('Clear ALL projects and tasks?')){ state.projects=[]; save(state); currentProjectId=null; render() } })

    function escapeHtml(s){ return (s||'').replace(/[&<>\\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'})[c]) }

    // init: if projects exist pick first
    if(state.projects.length>0) currentProjectId = state.projects[0].id
    render()
    console.warn('Reality: fully free and local. To share live across users use a backend (Firebase free tier is an option).')
  </script>
</body>
</html>
